apiVersion: batch/v1
kind: Job
metadata:
  annotations:
    argocd.argoproj.io/sync-wave: '3'
  name: create-loki-s3-secret
  namespace: openshift-gitops
spec:
  template:
    metadata:
      name: create-loki-s3-secret
    spec:
      containers:
        - name: create-loki-s3-secret
          image: registry.redhat.io/openshift4/ose-cli:latest
          command:
            - /bin/bash
            - '-c'
            - |
              echo "Read the secret generated by loki OBC"
              ACCESS_KEY=$(oc get secret loki-logging -n openshift-logging --template={{.data.AWS_ACCESS_KEY_ID}} | base64 -d)
              SECRET_KEY=$(oc get secret loki-logging -n openshift-logging --template={{.data.AWS_SECRET_ACCESS_KEY}} | base64 -d)
              BUCKET_NAME=loki-logging
              ENDPOINT=https://s3.openshift-storage.svc
              REGION=eu
              echo "Create the loki-logging-s3 secret"
              oc delete secret generic loki-logging-s3 -n openshift-logging --ignore-not-found
              oc create secret generic loki-logging-s3 -n openshift-logging \
              --from-literal access_key_id=$ACCESS_KEY \
              --from-literal access_key_secret=$SECRET_KEY \
              --from-literal bucketnames=$BUCKET_NAME \
              --from-literal endpoint=$ENDPOINT \
              --from-literal region=$REGION \
              --from-literal insecure=true
      restartPolicy: Never
      serviceAccountName: openshift-gitops-argocd-application-controller
